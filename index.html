<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日誌回覆產生器</title>
    <style>
        :root {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --card-bg: #2c2c2c;
            --input-bg: #383838;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            
            /* 灰色系按鈕 */
            --accent-color: #b0b0b0; 
            --accent-hover: #d1d1d1;
            
            /* 警示色系 (Red - 危險/嚴重) - Muted */
            --alert-bg: #382828;
            --alert-border: #c06060;
            --alert-text: #e8dada;

            /* 注意色系 (Yellow - 態度/學習狀況) - Muted */
            --caution-bg: #363328;
            --caution-border: #b8a860;
            --caution-text: #e8e6da;

            --border-radius: 12px;
            --spacing: 20px;
            --sidebar-width: 250px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            padding: var(--spacing);
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-right: 1px solid #333;
            transition: all 0.3s ease;
            position: relative;
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
        }

        /* 完全收合狀態 */
        .sidebar.collapsed {
            width: 0;
            padding: 0;
            border: none;
        }

        .sidebar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .sidebar h2 {
            font-size: 1.2rem;
            color: var(--text-main);
            font-weight: bold;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 12px 16px;
            text-align: left;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn.active, .nav-btn:hover {
            background-color: var(--accent-color);
            color: #121212;
            font-weight: bold;
        }

        /* Model Selector in Sidebar */
        .model-selector-container {
            margin-top: auto; 
            border-top: 1px solid #333;
            padding-top: 15px;
        }

        .model-selector-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
            display: block;
        }

        .model-select {
            width: 100%;
            background-color: var(--input-bg);
            color: var(--text-main);
            border: 1px solid #555;
            padding: 8px;
            border-radius: 6px;
            outline: none;
            cursor: pointer;
        }
        
        .model-select:hover {
            border-color: var(--accent-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: var(--spacing);
            display: flex;
            flex-direction: column;
            position: relative;
            min-width: 0; 
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing);
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Toggle Button (Hamburger) */
        .toggle-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-icon {
            width: 24px;
            height: 24px;
            fill: var(--text-muted);
        }

        .toggle-btn:hover .toggle-icon {
            fill: var(--text-main);
        }

        .api-btn {
            background-color: var(--card-bg);
            color: var(--text-main);
            border: 1px solid #555;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .api-btn:hover {
            background-color: #444;
        }

        /* Workspace Layout */
        .workspace {
            display: none;
            flex: 1;
            gap: var(--spacing);
            overflow: hidden; 
            margin-bottom: 30px; 
        }

        .workspace.active {
            display: flex;
        }

        .left-panel, .right-panel {
            flex: 1;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: var(--spacing);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            min-width: 300px;
        }

        .panel-title {
            margin-bottom: 15px;
            color: var(--accent-color);
            font-size: 1.1rem;
            font-weight: bold;
        }

        textarea, input[type="text"] {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid #555;
            color: var(--text-main);
            padding: 12px;
            border-radius: var(--border-radius);
            resize: none;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .action-btn {
            background-color: var(--accent-color);
            color: #121212;
            border: none;
            padding: 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            align-self: flex-end;
        }

        .action-btn:hover {
            background-color: var(--accent-hover);
        }

        .action-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            color: #888;
        }

        /* --- Status Bar --- */
        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background-color: var(--bg-color);
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 20px;
            gap: 20px;
            font-size: 0.8rem;
            color: #777;
            z-index: 10;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-item span {
            color: #aaa;
        }

        /* Teaching Log Specifics */
        .log-entry-card {
            background-color: var(--input-bg);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--accent-color);
            transition: background-color 0.3s;
        }

        .log-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .log-content {
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Red Alert Styles (Muted) */
        .log-entry-card.alert {
            background-color: var(--alert-bg);
            border-left-color: var(--alert-border);
        }
        .log-entry-card.alert .log-name {
            color: var(--alert-border);
        }
        .log-entry-card.alert .log-content {
            color: var(--alert-text);
        }

        /* Yellow Caution Styles (Muted) */
        .log-entry-card.caution {
            background-color: var(--caution-bg);
            border-left-color: var(--caution-border);
        }
        .log-entry-card.caution .log-name {
            color: var(--caution-border);
        }
        .log-entry-card.caution .log-content {
            color: var(--caution-text);
        }

        /* Warning Tag */
        .warning-tag {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: normal;
            letter-spacing: 0.5px;
        }

        /* Class Management Specifics */
        .class-input-group {
            margin-bottom: 15px;
        }
        .class-input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        /* AI Instruction Box Styles */
        .ai-instruction-box {
            background-color: #252525;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid var(--accent-color);
        }

        .instruction-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .instruction-input-wrapper input {
            margin-bottom: 0; 
        }

        .save-style-btn {
            background-color: #444;
            color: var(--text-main);
            border: 1px solid #555;
            padding: 0 15px;
            height: 45px;
            border-radius: var(--border-radius);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .save-style-btn:hover {
            background-color: #555;
            border-color: var(--accent-color);
        }

        .saved-styles-area {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .style-chip {
            background-color: #3a3a3a;
            color: #ccc;
            border: 1px solid #555;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .style-chip:hover {
            background-color: #505050;
            color: white;
            border-color: #777;
        }

        .delete-style-icon {
            color: #888;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            padding: 2px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
        }

        .delete-style-icon:hover {
            color: #ff6b6b;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .result-section h3 {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .result-block {
            background-color: var(--input-bg);
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            white-space: pre-wrap;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-color); 
        }
        ::-webkit-scrollbar-thumb {
            background: #444; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>日誌產生器</h2>
        </div>
        
        <button class="nav-btn active" onclick="switchTab('teaching-log')">
            教學日誌
        </button>
        <button class="nav-btn" onclick="switchTab('class-log')">
            帶班日誌
        </button>

        <div class="model-selector-container">
            <label class="model-selector-label">連線模型 (Model)</label>
            <select id="model-select" class="model-select" onchange="handleModelChange()">
            </select>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="header-left">
                <button class="toggle-btn" onclick="toggleSidebar()" title="切換選單">
                    <svg class="toggle-icon" viewBox="0 0 24 24">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </button>
                <h1 id="page-title">教學日誌</h1>
            </div>
            <button class="api-btn" onclick="openModal()">修改 API Key</button>
        </div>

        <div id="teaching-log" class="workspace active">
            <div class="left-panel">
                <div class="panel-title">輸入與設定</div>
                
                <div class="ai-instruction-box">
                    <label style="display:block; margin-bottom:5px; font-weight:bold;">AI 回覆風格指令 (選填)</label>
                    <div class="instruction-input-wrapper">
                        <input type="text" id="teaching-style-instruction" placeholder="例如：語氣要更活潑一點、特別稱讚數學教學...">
                        <button class="save-style-btn" onclick="saveCurrentStyle()">儲存風格</button>
                    </div>
                    <div id="saved-styles-container" class="saved-styles-area">
                        </div>
                </div>

                <div class="panel-title">日誌內容 (貼上原始教學日誌)</div>
                <textarea id="teaching-input" style="flex: 1;" placeholder="請在此貼上雜亂的教學日誌內容..."></textarea>
                <button id="btn-gen-teaching" class="action-btn" onclick="generateTeachingLog()">產生回覆</button>
            </div>
            <div class="right-panel">
                <div class="panel-title">AI 回覆區</div>
                <div id="teaching-output">
                </div>
            </div>
        </div>

        <div id="class-log" class="workspace">
            <div class="left-panel">
                <div class="panel-title">輸入與設定</div>
                
                <div class="ai-instruction-box">
                    <label style="display:block; margin-bottom:5px; font-weight:bold;">AI 指令輸入區</label>
                    <input type="text" id="class-instruction" placeholder="例如：今天網路不穩，有兩位大學伴斷線...">
                </div>

                <div class="class-input-group">
                    <label>1. 系統環境</label>
                    <textarea id="env-input" rows="5">1. 所有大學伴皆提早到教室準備，包含測試教材、耳麥、電腦、鏡頭等設備。
2. 重複提醒大學伴確認耳麥以及鏡頭設定，避免小學伴因為干擾聽不清楚。
3. 重複提醒大學伴開啟螢幕錄製。
4. 確認大學伴教材分享畫面以及音訊清晰度。</textarea>
                </div>

                <div class="class-input-group">
                    <label>2. 整體學習狀況</label>
                    <textarea id="learning-input" rows="6">1. 大學伴與小學依據前次的前測與對於小學伴的適應性調整教材內容。
2. 大多數大學伴皆可以融入Kahoot等數位教學平台，豐富教學內容。
3. 部分大學伴會融入平板等第二台數位裝置，具體化呈現教學內容。
4. 提醒大學伴盡量以自編以及融入課外知識編輯教材，並依據今天的課程進行難易度調整。
5. 大學伴與小學伴多已建立默契，有些大學伴持續嘗試適合小學伴的教學方法，並隨時觀察調整。</textarea>
                </div>

                <div class="class-input-group">
                    <label>3. 其他</label>
                    <textarea id="other-input" rows="3" placeholder="其他事項..."></textarea>
                </div>

                <button id="btn-gen-class" class="action-btn" onclick="generateClassLog()">生成/更新日誌</button>
            </div>
            <div class="right-panel">
                <div class="panel-title">日誌預覽</div>
                <div id="class-output">
                    <div style="color: var(--text-muted); text-align: center; margin-top: 20px;">
                        請在左側輸入指令並點擊生成
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">Model: <span id="status-model">Wait</span></div>
            <div class="status-item">|</div>
            <div class="status-item">Requests: <span id="status-req">0</span></div>
            <div class="status-item">|</div>
            <div class="status-item">Total Tokens: <span id="status-tokens">0</span></div>
        </div>
    </div>

    <div id="api-modal" class="modal-overlay">
        <div class="modal">
            <h3>設定 Google AI API Key</h3>
            <p style="margin-bottom: 15px; color: var(--text-muted); font-size: 0.9rem;">
                您的 Key 僅會儲存在本地瀏覽器中。
            </p>
            <input type="text" id="api-key-input" placeholder="Paste your API Key here">
            <button class="action-btn" style="width: 100%" onclick="saveApiKey()">儲存</button>
        </div>
    </div>

    <script>
        // --- State Management ---
        let apiKey = localStorage.getItem('google_ai_api_key');
        let requestCount = 0;
        let totalTokenCount = 0;

        // User Preferred Models
        const modelList = [
            "gemini-2.5-flash", "gemini-2.5-pro", "gemini-2.0-flash", 
            "gemini-2.0-flash-001", "gemini-2.0-flash-lite-001", "gemini-2.0-flash-lite", 
            "gemini-2.0-flash-lite-preview-02-05", "gemini-2.0-flash-lite-preview", 
            "gemini-flash-latest", "gemini-flash-lite-latest", "gemini-pro-latest", 
            "gemini-2.5-flash-lite", "gemini-2.5-flash-preview-09-2025", 
            "gemini-2.5-flash-lite-preview-09-2025", "gemini-robotics-er-1.5-preview"
        ];
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!apiKey) {
                document.getElementById('api-modal').style.display = 'flex';
            }
            initModelSelector();
            updateStatusBar();
            renderSavedStyles();
        });

        function initModelSelector() {
            const select = document.getElementById('model-select');
            modelList.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.text = model;
                select.appendChild(option);
            });
            if (modelList.length > 0) select.value = modelList[0];
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function handleModelChange() {
            requestCount = 0;
            totalTokenCount = 0;
            updateStatusBar();
        }

        function updateStatusBar() {
            const currentModel = document.getElementById('model-select').value;
            document.getElementById('status-model').innerText = currentModel;
            document.getElementById('status-req').innerText = requestCount;
            document.getElementById('status-tokens').innerText = totalTokenCount.toLocaleString();
        }

        // --- Style Management Functions ---
        function getSavedStyles() {
            const styles = localStorage.getItem('teaching_log_styles');
            return styles ? JSON.parse(styles) : [];
        }

        function renderSavedStyles() {
            const container = document.getElementById('saved-styles-container');
            const styles = getSavedStyles();
            
            container.innerHTML = '';
            
            if (styles.length === 0) return;

            styles.forEach((style, index) => {
                const chip = document.createElement('div');
                chip.className = 'style-chip';
                chip.onclick = () => applyStyle(style.prompt);
                
                const textSpan = document.createElement('span');
                textSpan.innerText = style.name;
                chip.appendChild(textSpan);

                const deleteIcon = document.createElement('span');
                deleteIcon.className = 'delete-style-icon';
                deleteIcon.innerHTML = '&times;';
                deleteIcon.title = '刪除此風格';
                deleteIcon.onclick = (e) => {
                    e.stopPropagation();
                    deleteStyle(index);
                };
                chip.appendChild(deleteIcon);

                container.appendChild(chip);
            });
        }

        function saveCurrentStyle() {
            const inputVal = document.getElementById('teaching-style-instruction').value.trim();
            if (!inputVal) {
                alert('請先在輸入框中輸入您想要儲存的指令風格。');
                return;
            }

            const styleName = prompt('請為這個風格取一個名稱（例如：嚴格版、活潑版）：');
            if (styleName && styleName.trim()) {
                const styles = getSavedStyles();
                styles.push({
                    name: styleName.trim(),
                    prompt: inputVal
                });
                localStorage.setItem('teaching_log_styles', JSON.stringify(styles));
                renderSavedStyles();
            }
        }

        function applyStyle(promptText) {
            const input = document.getElementById('teaching-style-instruction');
            input.value = promptText;
            
            input.style.borderColor = '#fff';
            setTimeout(() => {
                input.style.borderColor = '#555';
            }, 300);
        }

        function deleteStyle(index) {
            if (confirm('確定要刪除這個儲存的風格嗎？')) {
                const styles = getSavedStyles();
                styles.splice(index, 1);
                localStorage.setItem('teaching_log_styles', JSON.stringify(styles));
                renderSavedStyles();
            }
        }

        // --- Navigation ---
        function switchTab(tabId) {
            document.querySelectorAll('.workspace').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            
            const btnIndex = tabId === 'teaching-log' ? 0 : 1;
            document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');
            document.getElementById('page-title').innerText = tabId === 'teaching-log' ? '教學日誌' : '帶班日誌';
        }

        // --- API Key Handling ---
        function openModal() {
            document.getElementById('api-key-input').value = apiKey || '';
            document.getElementById('api-modal').style.display = 'flex';
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input').value.trim();
            if (input) {
                apiKey = input;
                localStorage.setItem('google_ai_api_key', apiKey);
                document.getElementById('api-modal').style.display = 'none';
            } else {
                alert('請輸入有效的 API Key');
            }
        }

        // --- Core AI Function ---
        async function callGeminiAPI(systemPrompt, userPrompt) {
            if (!apiKey) {
                alert('請先設定 API Key');
                openModal();
                throw new Error('No API Key');
            }

            const selectedModel = document.getElementById('model-select').value;
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: userPrompt }]
                    }],
                    system_instruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    generationConfig: {
                        temperature: 0.5,
                    }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`${selectedModel} Error: ${data.error.message}`);
                }

                requestCount++;
                if (data.usageMetadata && data.usageMetadata.totalTokenCount) {
                    totalTokenCount += data.usageMetadata.totalTokenCount;
                }
                updateStatusBar();

                return data.candidates[0].content.parts[0].text;

            } catch (error) {
                console.error("API Call Failed", error);
                alert(`請求失敗: ${error.message}`);
                throw error;
            }
        }

        // --- Feature 1: Teaching Log (Updated Logic) ---
        async function generateTeachingLog() {
            const input = document.getElementById('teaching-input').value;
            const styleInstruction = document.getElementById('teaching-style-instruction').value;
            
            if (!input.trim()) {
                alert('請輸入內容');
                return;
            }

            const btn = document.getElementById('btn-gen-teaching');
            const outputDiv = document.getElementById('teaching-output');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> 處理中...';
            outputDiv.innerHTML = '';

            const systemPrompt = `
                你是一個專業的教學日誌回覆助手。使用者提供的資料是從「教育部數位學伴計畫後台」直接複製的表格文字。
                資料格式非常混亂，請務必嚴格遵守以下解析邏輯：

                ### 1. 姓名解析邏輯（最重要）
                Step 1: 找到文字 \`國立嘉義大學\`。
                Step 2: 其後緊接的是 \`[夥伴學校名稱][大學伴姓名]\`。
                Step 3: 切開學校名稱與人名，取得「大學伴姓名」。
                Step 4: 忽略 \`（代課）\`。
                Step 5: 下一個是 \`小學伴\`。

                ### 2. 內容檢查與狀態判斷 (Status Check)
                請根據內容給予 \`status\` (狀態)：
                - **'alert' (紅燈)**：內容涉及霸凌、衝突、性平、家暴、安全疑慮等嚴重事件。
                - **'caution' (黃燈)**：標準放寬。只要內容提及學生**精神不佳、躁動、分心、注意力不集中、想睡覺、疲累、配合度低、學習意願不高**，或是任何關於學習態度、精神狀況的負面描述（即使是輕微的），都請歸類為此項。
                - **'normal' (綠燈)**：無上述情況，一般正常教學紀錄。

                字數檢查：若內容少於 5 個字，回覆：「請多寫一點，以便更全面地了解學生的學習狀況。」

                ### 3. 回覆原則 (重要)
                **[使用者自定義風格]：** "${styleInstruction || '無'}"
                1. **優先權**：若有使用者自定義風格，請優先依據其要求調整，但仍需遵守下列結構與禁忌。
                2. **內容深度 (重要)**：
                   - 請詳細閱讀該筆日誌中的「學習狀況」、「教材參考與應用」、「教學單元進度」、「教學流程及教法」。
                   - **必須**針對上述內容給予**具體**的回饋，不能只寫空泛的鼓勵。例如：提到具體的教學單元名稱、誇獎某個具體的教學方法或互動方式。
                3. **語氣與建議方式**：
                   - 保持正向、溫暖、鼓勵的語調。
                   - 若有可改進之處，請用「正向引導」的方式提出，**嚴禁出現「建議」二字**。
                   - 範例：「請繼續保持這種引導方式...」、「若能多嘗試...會更能引起動機...」、「期待看到更多...的互動」、「請繼續維持這樣的教學模式...」。
                4. **固定開頭**：回覆**必須**以「謝謝[稱呼]用心準備教學」開頭。
                5. **絕對禁止 Emoji**：任何表情符號都不可出現。

                ### 4. 輸出格式
                請直接回覆 JSON 陣列 (不要 markdown)：
                [{"name": "...", "reply": "...", "status": "normal"|"caution"|"alert", "reason": "..."}]
            `;

            try {
                const jsonPrompt = input + "\n\n請依據上述內容，產生符合規則的 JSON 陣列。";
                
                let rawText = await callGeminiAPI(systemPrompt, jsonPrompt);
                
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const results = JSON.parse(rawText);

                results.forEach(item => {
                    const card = document.createElement('div');
                    
                    // Logic for styles based on status
                    let cardClass = '';
                    let statusHtml = '';
                    
                    // Fallback for older prompts if status is undefined
                    const status = item.status || (item.hasWarning ? 'alert' : 'normal');

                    if (status === 'alert') {
                        cardClass = 'alert';
                        statusHtml = `<span class="warning-tag" style="background-color: var(--alert-border); color: white;">${item.reason || '安全疑慮'}</span>`;
                    } else if (status === 'caution') {
                        cardClass = 'caution';
                        statusHtml = `<span class="warning-tag" style="background-color: var(--caution-border); color: #121212;">${item.reason || '學習狀況'}</span>`;
                    }

                    card.className = `log-entry-card ${cardClass}`;
                    card.innerHTML = `
                        <div class="log-name">
                            ${item.name}
                            ${statusHtml}
                        </div>
                        <div class="log-content">${item.reply}</div>
                    `;
                    outputDiv.appendChild(card);
                });

            } catch (e) {
                outputDiv.innerHTML = `<div style="color: #ff6b6b">發生錯誤，請重試。<br>詳細: ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '產生回覆';
            }
        }

        // --- Feature 2: Class Log ---
        async function generateClassLog() {
            const instruction = document.getElementById('class-instruction').value;
            const envText = document.getElementById('env-input').value;
            const learnText = document.getElementById('learning-input').value;
            const otherText = document.getElementById('other-input').value;

            const btn = document.getElementById('btn-gen-class');
            const outputDiv = document.getElementById('class-output');

            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> 生成中...';

            const systemPrompt = `
                你是一個帶班日誌助手。
                任務：根據「當前內容」及「指令」，重新生成日誌。
                規則：
                - 若有指令，自然融入並重新編號。
                - 保持專業、客觀。
                - **禁止 Emoji**。
                - 使用繁體中文。
                - 輸出格式：JSON 物件 {"environment": "...", "learning": "...", "others": "..."}
            `;

            const userPrompt = `
                【指令】：${instruction}
                【1. 系統環境】：${envText}
                【2. 整體學習狀況】：${learnText}
                【3. 其他】：${otherText}
            `;

            try {
                let rawText = await callGeminiAPI(systemPrompt, userPrompt);
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const result = JSON.parse(rawText);

                outputDiv.innerHTML = `
                    <div class="result-section">
                        <h3>1. 系統環境</h3>
                        <div class="result-block">${result.environment}</div>
                    </div>
                    <div class="result-section">
                        <h3>2. 整體學習狀況</h3>
                        <div class="result-block">${result.learning}</div>
                    </div>
                    <div class="result-section">
                        <h3>3. 其他</h3>
                        <div class="result-block">${result.others || '無'}</div>
                    </div>
                `;

            } catch (e) {
                outputDiv.innerHTML = `<div style="color: #ff6b6b">發生錯誤: ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '生成/更新日誌';
            }
        }
    </script>
</body>
</html>
